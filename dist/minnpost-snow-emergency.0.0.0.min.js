/*! minnpost-snow-emergency - v0.0.0 - 2014-02-18
* https://github.com/minnpost/minnpost-snow-emergency
* Copyright (c) 2014 MinnPost; Licensed MIT */

define("helpers",["jquery","underscore"],function(a,b){return{formatNumber:function(a,c){c=b.isUndefined(c)?2:c;var d=/(\d+)(\d{3})/;for(split=a.toFixed(c).toString().split(".");d.test(split[0]);)split[0]=split[0].replace(d,"$1,$2");return c?split[0]+"."+split[1]:split[0]},formatCurrency:function(a){return"$"+this.formatNumber(a,2)},formatPercent:function(a){return this.formatNumber(100*a,1)+"%"},formatPercentChange:function(a){return(a>0?"+":"")+this.formatPercent(a)},hash:function(a){return Math.abs(b.reduce(a.split(""),function(a,b){return a=(a<<5)-a+b.charCodeAt(0),a&a},0))},identifier:function(a){return a.toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-").replace(/[^\w-]+/g,"")},isMSIE:function(){var a=/(msie) ([\w.]+)/i.exec(navigator.userAgent);return a?parseInt(a[2],10):!1},jsonpRequest:function(){var c=arguments[0];return c.dataType="jsonp",c.jsonpCallback="mpServerSideCachingHelper"+b.hash(c.url),a.ajax.apply(a,[c])},getLocalData:function(c,d){var e=this,f=d.jsonpProxy,g=!1,h=[];return this.data=this.data||{},c=b.isArray(c)?c:[c],d&&0===d.dataPath.indexOf("http")&&(g=!0),b.each(c,function(c){var i;b.isUndefined(e.data[c])&&(i=g?e.jsonpRequest({url:f+encodeURI(d.dataPath+c+".json")}):a.getJSON(d.dataPath+c+".json"),a.when(i).done(function(a){e.data[c]=a}),h.push(i))}),a.when.apply(a,h)},getRemoteData:function(b){return b.dataType="jsonp",this.options.remoteProxy&&(b.url=b.url+"&callback=proxied_jqjsp",b.url=app.options.remoteProxy+encodeURIComponent(b.url),b.callback="proxied_jqjsp",b.cache=!0),a.ajax(b)}}}),define("text!templates/application.mustache",[],function(){return'<div class="message-container"></div>\n\n<div class="content-container">\n\n  <form class="location-search-form">\n    <input type="text" class="address-input" value="{{ address }}" placeholder="Enter address" />\n    <button type="submit" on-tap="addressSearch">Search</button>\n    <button type="submit" on-tap="geolocateSearch">Geolocation</button>\n  </form>\n\n  <div id="snow-emergency-map"></div>\n\n</div>\n\n<div class="footnote-container">\n  <div class="footnote">\n    <p>Some code, techniques, and data on <a href="https://github.com/zzolo/minnpost-snow-emergency" target="_blank">Github</a>.</p>\n\n  </div>\n</div>\n'}),define("text!templates/loading.mustache",[],function(){return'<div class="loading-container">\n  <div class="loading"><span>Loading...</span></div>\n</div>'}),require.config({shim:{cartodb:{exports:"cartodb"}},baseUrl:"js",paths:{requirejs:"../bower_components/requirejs/require",text:"../bower_components/text/text",jquery:"../bower_components/jquery/jquery.min",underscore:"../bower_components/underscore/underscore",Ractive:"../bower_components/ractive/build/Ractive-legacy.min","Ractive-events-tap":"../bower_components/ractive-events-tap/Ractive-events-tap.min",moment:"../bower_components/moment/min/moment.min",cartodb:"../bower_components/cartodb.js/dist/cartodb","minnpost-snow-emergency":"app"}}),define("minnpost-snow-emergency",["jquery","underscore","helpers","Ractive","Ractive-events-tap","cartodb","text!templates/application.mustache","text!templates/loading.mustache"],function(a,b,c,d,e,f,g,h){var i=window.L;f=window.cartodb;var j=function(c){this.options=b.extend(this.defaultOptions,c),this.el=this.options.el,this.el&&(this.$el=a(this.el),this.$content=this.$el.find(".content-container"))};return b.extend(j.prototype,{start:function(){var c=this;this.snowEmergencyDay=2,this.isSnowEmergency=!0,this.mainView=new d({el:this.$el,template:g,data:{},partials:{loading:h}}),this.map=new i.Map("snow-emergency-map",{center:[44.970753517451946,-93.26185335000002],zoom:12}),i.tileLayer("//{s}.tiles.mapbox.com/v3/minnpost.map-wi88b700/{z}/{x}/{y}.png").addTo(this.map),f.createLayer(this.map,"http://zzolo-minnpost.cartodb.com/api/v2/viz/3fb9a154-9604-11e3-b5ac-0e625a1c94a6/viz.json").addTo(this.map).on("done",function(){}).on("error",function(){}),this.$el.find("form").on("submit",function(a){a.preventDefault()}),this.mainView.on("addressSearch",function(d){d.original.preventDefault();var e=this.get("address");e&&a.getJSON(c.options.mapQuestQuery.replace("[[[ADDRESS]]]",e),function(a){var d;b.size(a.results[0].locations)>0&&b.isObject(a.results[0].locations[0].latLng)&&(d=a.results[0].locations[0].latLng,c.closestRoutes(d.lat,d.lng))})}),this.mainView.on("geolocateSearch",function(a){a.original.preventDefault(),navigator.geolocation.getCurrentPosition(function(a){c.closestRoutes(a.coords.latitude,a.coords.longitude)})})},closestRoutes:function(b,c){var d,e=this;this.location=[b,c],this.map.setView([b,c],17),d="SELECT * FROM snow_routes WHERE day"+this.snowEmergencyDay.toString()+" = 0 ORDER BY ST_SetSRID(the_geom, 4326) <-> ST_SetSRID(ST_MakePoint("+c+", "+b+") , 4326) LIMIT 20",a.getJSON("http://zzolo-minnpost.cartodb.com/api/v2/sql?format=GeoJSON&q="+d,function(a){e.renderRoutes(a)})},renderRoutes:function(a){b.isObject(this.routeLayer)&&(this.map.removeLayer(this.routeLayer),this.map.removeLayer(this.locationLayer)),this.routeLayer=new i.geoJson(a,{style:function(){var a="#B21A10";return{fillColor:a,color:a,weight:3,opacity:.55,fillOpacity:.75}}}),this.locationLayer=i.circleMarker(this.location,{radius:8,fillColor:"#10B21A",color:"#10B21A",weight:10,opacity:.45,fillOpacity:.85}),this.map.addLayer(this.routeLayer),this.map.addLayer(this.locationLayer),this.map.fitBounds(this.routeLayer.getBounds())},defaultOptions:{projectName:"minnpost-snow-emergency",mapQuestQuery:"http://www.mapquestapi.com/geocoding/v1/address?key=Fmjtd%7Cluub2d01ng%2C8g%3Do5-9ua20a&outFormat=json&callback=?&countrycodes=us&maxResults=1&location=[[[ADDRESS]]]"}}),j});